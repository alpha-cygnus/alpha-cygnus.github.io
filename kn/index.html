<html>
<head>
<title>KaNa</title>
<script src="../lib/jquery-2.1.1.js"></script>
<script src="../lib/Tone.js"></script>
<script src="../lib/kefir.js"></script>
<script src="kn.js"></script>
<script>
"use strict";
$(() => {
	//window.keyNoteStream.log('kns');
	var kbd = new Keyboard();
	var m2n = new Midi2Note();
	var n2c = new Note2CV();
	var m2t = new Note2Trigger();
	var env = new Env(0.01);
	var dest = new Dest();
	var osc = new Osc(1);
	var dg = new Gain(0.12);
	var flt = new Filter();
	var clk = new Clock();
	var seq = new Sequence('xxxx....x...x...xx..');
	var nseq = new Sequence('0,4,7');
	var div = new Sequence('xx..'); // div 6
	
	window.mainVolume = dest._volume;
	
	kbd.out.connect(m2n.inp);
	kbd.out.connect(m2t.inp);
	m2n.out.connect(n2c.inp);
	seq.out.connect(nseq.clock);
	nseq.out.connect(n2c.inp);
	m2t.out.connect(env.trigger);
	clk.out.connect(div.clock);
	div.out.connect(seq.clock);
	seq.out.connect(env.trigger);
	
	n2c.out.connect(osc.detune);
	osc.out.connect(env.inp);
	env.out.connect(dg.inp);
	dg.out.connect(dest.inp);
	
	var pl = new PINLogger();
	nseq.out.connect(pl.inp);
	pl.attachUI($('#PINLogger'));
	//nt.stream.log();
	var prevT = 0; //Tone.context.currentTime;
	var dT = 1/100;
	var cT = 4;
	window.stopped = 0;
	setInterval(() => {
		if (window.stopped) return;
		var curT = Tone.context.currentTime;
		var cnt = 0;
		if (curT >= prevT + dT) {
			if (prevT > 0) console.warn('TICKS WERE SKIPPED');
			prevT = curT; // realign
		}
		while (prevT < curT + cT*dT) {
			prevT += dT;
			_fabrique.doTick(prevT);
		};
	}, 15);
})

function StopItAll() {
	window.stopped = 1;
	window.mainVolume.value = 0;
}
	
</script>
</head>
<body>
	<h1 onclick="console.log(1)">KaNa</h1>
	<div id="PINLogger"></div>
	<button onclick="StopItAll()">PANIC</button>
</body>
</html>