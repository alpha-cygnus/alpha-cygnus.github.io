<html>
<head>
<title>KaNa</title>
<script src="../lib/jquery-2.1.1.js"></script>
<script src="../lib/Tone.js"></script>
<script src="../lib/kefir.js"></script>
<script src="../lib/peg-0.9.0.js"></script>

<script src="../lib/base64.js"></script>
<script src="../lib/rawinflate.js"></script>
<script src="../lib/rawdeflate.js"></script>
<!--script src="../lib/cytoscape.js"></script>
<link href="../lib/vis.css" rel="stylesheet" type="text/css" />
		<script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
		<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.1.2/cytoscape-dagre.js"></script-->
<script src="kncore.js"></script>
<script src="knmeta.js"></script>
<link href="main.css" rel="stylesheet" type="text/css" />
<script src="simple64.js"></script>
<!--script src="../lib/viz.js"></script-->
<script>
"use strict";
function compress(s) {
	var zipped = RawDeflate.deflate(s, 9);	
	return Simple64.encode(zipped);
}
function decompress(s) {
	var zipped = Simple64.decode(s);
	return RawDeflate.inflate(zipped);
}
$(() => {
	Kefir.zip([
		Kefir.fromPromise($.get('kn.pegjs')),
		Kefir.fromPromise($.get('prelude.kn')),
		Kefir.fromPromise($.get('overture.kn')),
		// Kefir.fromPromise($.get('kn2.pegjs')),
		// Kefir.fromPromise($.get('overture2.kn')),
	]).onValue(data => {
		var grammar = data[0];
		var prelude = data[1];
		var overture = data[2];
		// var gr2 = data[3];
		// var ov2 = data[4];
		console.log('Loaded:', grammar.length, prelude.length);
		//var parserSource = PEG.buildParser(grammar, {output: 'source'});
		//console.log(parserSource);
		// try {
			// try {
				var parser = PEG.buildParser(grammar);
			// } catch(e) {
			// 	console.log(e);
			// 	throw `Error parsing grammar at ${e.location.start.line}:${e.location.start.column}: ${e.message}`;
			// }
			// try {
				var parsedPrelude = parser.parse(prelude);
			// } catch(e) {
			// 	console.log(e);
			// 	//var msg = 'Error parsing prelude at', e.location.start.line + ':' + e.location.start.column + ':', e.message;
			// 	throw `Error parsing prelude at ${e.location.start.line}:${e.location.start.column}: ${e.message}`;
			// }
			//console.log(JSON.stringify(parsedPrelude[0], null));
			for (var c in knMeta) {
				if (c === knMainClass) continue;
				var cls = knMeta[c];
				cls.__internal = true;
			}
			// try {
				// var par2 = PEG.buildParser(gr2);
			// } catch(e) {
			// 	console.log(e);
			// 	console.error(`Error parsing gr2 at ${e.location.start.line}:${e.location.start.column}: ${e.message}`);
			// 	throw e;
			// }
			// try {
			// 	var parsedOverture2 = par2.parse(ov2);
			// } catch(e) {
			// 	console.log(e);
			// 	console.error(`Error parsing ov2 at ${e.location.start.line}:${e.location.start.column}: ${e.message}`);
			// 	throw e;
			// }
			// try {
				var parsedOverture = parser.parse(overture);
			// } catch(e) {
			// 	console.log(e);
			// 	throw `Error parsing overture at ${e.location.start.line}:${e.location.start.column}: ${e.message}`;
			// }
			for (var c in knMeta) {
				var cls = knMeta[c];
				if (cls.__internal) continue;
				console.log('// ' + c);
				cls.compile();
				// var src = knCompile(cls);
				// console.log(src);
				// var cc = eval(src);
				// console.log(cc);
				// window[c] = cc;
			}
		// }
		// catch (msg) {
		// 	$('#error').html($('#error').html() + msg + '<br />');
		// 	console.error(msg);
		// }
		
		var klaz = 'SpreadingLead'; //knMainClass;
		var ps = knMeta[klaz].getPlant();
		$('#diaLink').attr('href', 'http://www.plantuml.com/plantuml/svg/' + compress(ps)).show();
		
		var src = knMeta[klaz].getDot();
		//console.log(src);
		//var res = Viz(src);
		//'digraph g { n0[shape=record,label="{{<a>a|<b>b}|abracadabra|{c|d|f}}"]; n0:a -> a; n0:b -> b }');
		//console.log(res);
		//$('#vis-network').html(res);

		window.main = new window[knMainClass]();
		_fabrique.start();
	});
	
})

function StopItAll() {
	_fabrique.stop();
	window.mainVolume.value = 0;
}

</script>
</head>
<body>
	<h1 onclick="console.log(1)">KaNa</h1>
	<div id="vis-network"></div>
	<!--div id="PINLogger"></div-->
	<button onclick="StopItAll()" id="PANIC">PANIC</button>
	<div id="error"></div>
	<a style:"display:none" target="_blank" id="diaLink" href="#">Diagram</a>
	<div class="kbd" style="display:block">
		<div class="kbd-up">
			<span 
			data-note="48" class="w up bl">&nbsp;</span><span 
			data-note="49" class="k up"><span class="label">s</span></span><span 
			data-note="50" class="w up">&nbsp;</span><span 
			data-note="51" class="k up"><span class="label">d</span></span><span
			data-note="52" class="w up br">&nbsp;</span><span 
			data-note="53" class="w up w1 bl">&nbsp;</span><span 
			data-note="54" class="k up"><span class="label">g</span></span><span 
			data-note="55" class="w up w1">&nbsp;</span><span 
			data-note="56" class="k up"><span class="label">h</span></span><span 
			data-note="57" class="w up w1">&nbsp;</span><span 
			data-note="58" class="k up"><span class="label">j</span></span><span 
			data-note="59" class="w up w1 br">&nbsp;</span><span 
			data-note="60" class="w up bl">&nbsp;</span><span 
			data-note="61" class="k up"><span class="label">2</span></span><span 
			data-note="62" class="w up">&nbsp;</span><span 
			data-note="63" class="k up"><span class="label">3</span></span><span
			data-note="64" class="w up br">&nbsp;</span><span 
			data-note="65" class="w up w1 bl">&nbsp;</span><span 
			data-note="66" class="k up"><span class="label">5</span></span><span 
			data-note="67" class="w up w1">&nbsp;</span><span 
			data-note="68" class="k up"><span class="label">6</span></span><span 
			data-note="69" class="w up w1">&nbsp;</span><span 
			data-note="70" class="k up"><span class="label">7</span></span><span 
			data-note="71" class="w up w1 br">&nbsp;</span><span 
			data-note="72" class="w up bl">&nbsp;</span><span 
			data-note="73" class="k up"><span class="label">9</span></span><span 
			data-note="74" class="w up">&nbsp;</span><span 
			data-note="75" class="k up"><span class="label">0</span></span><span
			data-note="76" class="w up br">&nbsp;</span>
		<div class="kbd-down">
			<span
			data-note="48" class="w down bl br"><span class="label">z</span></span><span 
			data-note="50" class="w down bl br"><span class="label">x</span></span><span 
			data-note="52" class="w down bl br"><span class="label">c</span></span><span 
			data-note="53" class="w down bl br"><span class="label">v</span></span><span 
			data-note="55" class="w down bl br"><span class="label">b</span></span><span 
			data-note="57" class="w down bl br"><span class="label">n</span></span><span 
			data-note="59" class="w down bl br"><span class="label">m</span></span><span
			data-note="60" class="w down bl br"><span class="label">q</span></span><span 
			data-note="62" class="w down bl br"><span class="label">w</span></span><span 
			data-note="64" class="w down bl br"><span class="label">e</span></span><span 
			data-note="65" class="w down bl br"><span class="label">r</span></span><span 
			data-note="67" class="w down bl br"><span class="label">t</span></span><span 
			data-note="69" class="w down bl br"><span class="label">y</span></span><span 
			data-note="71" class="w down bl br"><span class="label">u</span></span><span
			data-note="72" class="w down bl br"><span class="label">i</span></span><span 
			data-note="74" class="w down bl br"><span class="label">o</span></span><span 
			data-note="76" class="w down bl br"><span class="label">p</span></span>
		</div>
	</div>
	<div>
		<div class="seven-seg d-0">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-0">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-1">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-2">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-3">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-4">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-5">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-6">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-7">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-8">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div><div class="seven-seg d-9">
			<span class="t m"></span>
			<span class="t l"></span>
			<span class="t r"></span>
			<span class="m u"></span>
			<span class="m d"></span>
			<span class="b l"></span>
			<span class="b r"></span>
			<span class="b m"></span>
		</div>
		<div class="seven-seg2 minus">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-0">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-1">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-2">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-3">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-4">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-5">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-6">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-7">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-8">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div><div class="seven-seg2 d-9">
			<span class="t m"><a></a><a></a></span>
			<span class="t l"><a></a><a></a></span>
			<span class="t r"><a></a><a></a></span>
			<span class="c m"><a></a><a></a></span>
			<span class="b r"><a></a><a></a></span>
			<span class="b l"><a></a><a></a></span>
			<span class="b m"><a></a><a></a></span>
		</div>
	</div>
</body>
</html>