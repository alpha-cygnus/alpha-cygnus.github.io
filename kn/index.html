<html>
<head>
<title>KaNa</title>
<script src="../lib/jquery-2.1.1.js"></script>
<script src="../lib/Tone.js"></script>
<script src="../lib/kefir.js"></script>
<script src="../lib/peg-0.9.0.js"></script>
<script src="../lib/cytoscape.js"></script>
<link href="../lib/vis.css" rel="stylesheet" type="text/css" />
		<script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
		<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.1.2/cytoscape-dagre.js"></script>
<script src="kncore.js"></script>
<script src="knmeta.js"></script>
<link href="main.css" rel="stylesheet" type="text/css" />
<script>
"use strict";
$(() => {
	Kefir.zip([
		Kefir.fromPromise($.get('kn.pegjs')),
		Kefir.fromPromise($.get('prelude.kn')),
		Kefir.fromPromise($.get('overture.kn')),
	]).onValue(data => {
		var grammar = data[0];
		var prelude = data[1];
		var overture = data[2];
		console.log('Loaded:', grammar.length, prelude.length);
		//var parserSource = PEG.buildParser(grammar, {output: 'source'});
		//console.log(parserSource);
		// try {
			// try {
				var parser = PEG.buildParser(grammar);
			// } catch(e) {
			// 	console.log(e);
			// 	throw `Error parsing grammar at ${e.location.start.line}:${e.location.start.column}: ${e.message}`;
			// }
			// try {
				var parsedPrelude = parser.parse(prelude);
			// } catch(e) {
			// 	console.log(e);
			// 	//var msg = 'Error parsing prelude at', e.location.start.line + ':' + e.location.start.column + ':', e.message;
			// 	throw `Error parsing prelude at ${e.location.start.line}:${e.location.start.column}: ${e.message}`;
			// }
			//console.log(JSON.stringify(parsedPrelude[0], null));
			for (var c in knMeta) {
				if (c === knMainClass) continue;
				var cls = knMeta[c];
				cls.__internal = true;
			}
			// try {
				var parsedOverture = parser.parse(overture);
			// } catch(e) {
			// 	console.log(e);
			// 	throw `Error parsing overture at ${e.location.start.line}:${e.location.start.column}: ${e.message}`;
			// }
			for (var c in knMeta) {
				var cls = knMeta[c];
				if (cls.__internal) continue;
				console.log('// ' + c);
				cls.compile();
				// var src = knCompile(cls);
				// console.log(src);
				// var cc = eval(src);
				// console.log(cc);
				// window[c] = cc;
			}
		// }
		// catch (msg) {
		// 	$('#error').html($('#error').html() + msg + '<br />');
		// 	console.error(msg);
		// }
		new window[knMainClass]();
		_fabrique.start();
		var klaz = 'TestSynth';
		console.log(knMeta[klaz].getPlant());

		var cy = cytoscape({
			container: $('#vis-network'),
			// elements: [
			// 	{
			// 		data: { id: 'n1', label: 'Source' }
			// 	},
			// 	{
			// 		data: { id: 'n1.e1', label: 'e1', parent: 'n1' }
			// 	},
			// 	{
			// 		data: { id: 'n1.e2', label: 'e2', parent: 'n1' }
			// 	},
			// 	{
			// 		data: { id: 'n2', label: 'Targ' }
			// 	},
			// 	{
			// 		data: { id: 'n2.e1', label: 'e1', parent: 'n2' }
			// 	},
			// 	{
			// 		data: { id: 'n2.e2', label: 'e2', parent: 'n2' }
			// 	},

			// 	{
			// 		data: { id: 'n1.e1->n2.e2', source: 'n1.e1', target: 'n2.e2' }
			// 	},
			// ],
			elements: knMeta[klaz].getCyEles(),
			layout: {
				name: 'dagre',
			},
			style: [
				{
					selector: 'node',
					style: {
						'content': 'data(label)',
						'text-opacity': 0.5,
						'text-valign': 'center',
						'text-halign': 'right',
						'background-color': '#11479e'
					}
				},

				{
					selector: 'edge',
					style: {
						'width': 4,
						'target-arrow-shape': 'triangle',
						'line-color': '#9dbaea',
						'target-arrow-color': '#9dbaea'
					}
				}
			],
		});
	});
	
})

function StopItAll() {
	_fabrique.stop();
	window.mainVolume.value = 0;
}

</script>
</head>
<body>
	<h1 onclick="console.log(1)">KaNa</h1>
	<div id="vis-network"></div>
	<!--div id="PINLogger"></div-->
	<button onclick="StopItAll()" id="PANIC">PANIC</button>
	<div id="error"></div>
	<div class="kbd" style="display:block">
		<div class="kbd-up">
			<span 
			data-note="48" class="w up bl">&nbsp;</span><span 
			data-note="49" class="k up"><span class="label">s</span></span><span 
			data-note="50" class="w up">&nbsp;</span><span 
			data-note="51" class="k up"><span class="label">d</span></span><span
			data-note="52" class="w up br">&nbsp;</span><span 
			data-note="53" class="w up w1 bl">&nbsp;</span><span 
			data-note="54" class="k up"><span class="label">g</span></span><span 
			data-note="55" class="w up w1">&nbsp;</span><span 
			data-note="56" class="k up"><span class="label">h</span></span><span 
			data-note="57" class="w up w1">&nbsp;</span><span 
			data-note="58" class="k up"><span class="label">j</span></span><span 
			data-note="59" class="w up w1 br">&nbsp;</span><span 
			data-note="60" class="w up bl">&nbsp;</span><span 
			data-note="61" class="k up"><span class="label">2</span></span><span 
			data-note="62" class="w up">&nbsp;</span><span 
			data-note="63" class="k up"><span class="label">3</span></span><span
			data-note="64" class="w up br">&nbsp;</span><span 
			data-note="65" class="w up w1 bl">&nbsp;</span><span 
			data-note="66" class="k up"><span class="label">5</span></span><span 
			data-note="67" class="w up w1">&nbsp;</span><span 
			data-note="68" class="k up"><span class="label">6</span></span><span 
			data-note="69" class="w up w1">&nbsp;</span><span 
			data-note="70" class="k up"><span class="label">7</span></span><span 
			data-note="71" class="w up w1 br">&nbsp;</span><span 
			data-note="72" class="w up bl">&nbsp;</span><span 
			data-note="73" class="k up"><span class="label">9</span></span><span 
			data-note="74" class="w up">&nbsp;</span><span 
			data-note="75" class="k up"><span class="label">0</span></span><span
			data-note="76" class="w up br">&nbsp;</span>
		<div class="kbd-down">
			<span
			data-note="48" class="w down bl br"><span class="label">z</span></span><span 
			data-note="50" class="w down bl br"><span class="label">x</span></span><span 
			data-note="52" class="w down bl br"><span class="label">c</span></span><span 
			data-note="53" class="w down bl br"><span class="label">v</span></span><span 
			data-note="55" class="w down bl br"><span class="label">b</span></span><span 
			data-note="57" class="w down bl br"><span class="label">n</span></span><span 
			data-note="59" class="w down bl br"><span class="label">m</span></span><span
			data-note="60" class="w down bl br"><span class="label">q</span></span><span 
			data-note="62" class="w down bl br"><span class="label">w</span></span><span 
			data-note="64" class="w down bl br"><span class="label">e</span></span><span 
			data-note="65" class="w down bl br"><span class="label">r</span></span><span 
			data-note="67" class="w down bl br"><span class="label">t</span></span><span 
			data-note="69" class="w down bl br"><span class="label">y</span></span><span 
			data-note="71" class="w down bl br"><span class="label">u</span></span><span
			data-note="72" class="w down bl br"><span class="label">i</span></span><span 
			data-note="74" class="w down bl br"><span class="label">o</span></span><span 
			data-note="76" class="w down bl br"><span class="label">p</span></span>
		</div>
	</div>
</body>
</html>