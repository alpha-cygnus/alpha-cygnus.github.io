<html>
<head>
<title>KaNa</title>
<script src="../lib/jquery-2.1.1.js"></script>
<script src="../lib/Tone.js"></script>
<script src="../lib/kefir.js"></script>
<script src="kn.js"></script>
<script>
"use strict";
$(() => {
	//window.keyNoteStream.log('kns');
	var kbd = new Keyboard();
	var m2n = new Midi2Note();
	var n2c = new Note2CV();
	var m2t = new Note2Trigger();
	//var p2a = new P2A();
	var env = new Env();

	var sin = Tone.context.createOscillator();
	sin.type = 'square';
	var g = Tone.context.createGain();
	
	kbd.out.connect(m2n.inp);
	kbd.out.connect(m2t.inp);
	m2n.out.connect(n2c.inp);
	//m2t.out.connect(p2a.inp);
	m2t.out.connect(env.trigger);

	// g.gain.value = 0;
	// g.connect(Tone.context.destination);
	
	n2c.out.out.connect(sin.detune);
	//p2a.out.out.connect(g.gain);
	//env.out.out.connect(g.gain);

	env.inp.plug(sin);
	env.out.out.connect(Tone.context.destination);
	sin.start();
	
	var pl = new PINLogger();
	m2n.out.connect(pl.inp);
	pl.attachUI($('#PINLogger'));
	//nt.stream.log();
	var prevT = 0; //Tone.context.currentTime;
	var dT = 1/50;
	var cT = 2;
	setInterval(() => {
		var curT = Tone.context.currentTime;
		var cnt = 0;
		if (curT >= prevT + dT) {
			if (prevT > 0) console.warn('TICKS WERE SKIPPED');
			prevT = curT; // realign
		}
		while (prevT < curT + cT*dT) {
			prevT += dT;
			_fabrique.doTick(prevT);
		};
	}, 15);
})
	
</script>
</head>
<body>
	<h1 onclick="console.log(1)">KaNa</h1>
	<div id="PINLogger"/>
</body>
</html>