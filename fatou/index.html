<html>

<head>
<title>Fatou dust</title>
<script src="http://code.jquery.com/jquery-1.11.0.js"></script>
<script type="text/javascript" src="../lib/webgl-utils.js"></script>
<script type="text/javascript" src="../lib/wgl.js"></script>

<script id="vsFatou" type="x-shader/x-vertex">
	precision mediump float;
	attribute vec4 vPosition;
	uniform vec4 uRatio;
	varying vec4 Position;

	void main() {
		gl_Position = vPosition * uRatio;
		Position = vPosition;
	}
</script>

<script id="fsFatou" type="x-shader/x-fragment">
	precision mediump float;
	uniform vec3 uPos;
	varying vec4 Position;

	void main() {
		float sx = Position.x * 1.5;
		float sy = -Position.y * 1.5;

		vec2 z = vec2(sx, sy);
		vec2 z1 = vec2(sx, sy);
		vec2 c = vec2(uPos.x, uPos.y);
		float dist = 0.0;
		float step = 0.0;
		//float dist2 = 0.0;
		int broken = 0;
		for (int i = 0; i < 256; i++) {
			z1 = vec2(z.x*z.x - z.y*z.y, 2.0*z.x*z.y) + c;
			dist += distance(z1, z)/100.0;
			//dist2 = dist/10.0;
			z = z1;
			if (length(z) > 100.0) {
				broken = 1;
				break;
			}
			step++;
		}
		if (broken > 0) {
			//if (step > 256.0) step -= 256.0;
			gl_FragColor = vec4(0.0, sqrt(fract(step/256.0)), 0.0, 1);
		} else {
			//gl_FragColor = vec4(0.0, 0.0, 0.7, 1);
			float c = (abs(fract(dist*5.0)-0.5)*2.0);
			gl_FragColor = vec4(0.0, 0.0, 1.0 - c*c, 1);
			//gl_FragColor = vec4(step/255.0*1.0, step/255.0*0.0, step/255.0*0.0, 1);
		}

	}
</script>


<script type="text/javascript">
	var gl;
	var canvas;
	var wgl;

	var quadProgram;

	function initShaders()
	{
		//debugger;
		quadProgram = wgl.compileProgram("vsFatou", "fsFatou");
		quadProgram.vPosition = gl.getAttribLocation(quadProgram, "vPosition");
		quadProgram.uRatio = gl.getUniformLocation(quadProgram, "uRatio");
		quadProgram.uPos = gl.getUniformLocation(quadProgram, "uPos");
	}

	var quadBuffer;

	function initBuffers()
	{
		var quad = [
			-1,  1,
			-1, -1,
			 1,  1,
			 1, -1,
		];
		quadBuffer = wgl.createBuffer(quad);
	}

	var ratioX = 1;
	var ratioY = 1;
	// var rotateAngle = 0;
	// var tiltAngle = 0;
	var scaleFactor = 1;
	// var rotateSpeed = -0.125;
	// var tiltSpeed = 0;
	var cx = 0;
	var cy = 0;
	var midX = 0;
	var midY = 0;
	var cScale = 2;

	function drawScene()
	{
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		gl.enable(gl.BLEND);
		gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

		gl.useProgram(quadProgram);
		gl.disable(gl.DEPTH_TEST);

		gl.bindBuffer(gl.ARRAY_BUFFER, quadBuffer);
		gl.enableVertexAttribArray(quadProgram.vPosition);
		gl.vertexAttribPointer(quadProgram.vPosition, 2, gl.FLOAT, false, 8, 0);
		
		var x = cx + midX;
		var y = cy + midY;
		gl.uniform3f(quadProgram.uPos, x, y, 0);
		x = Math.round(x*1000)/1000;
		y = Math.round(y*1000)/1000;
		$('#divInfo').html(x + '+' + y + 'i');

		var minScale = 0.5, maxScale = 2.0 / (ratioX < ratioY ? ratioX : ratioY);
		if (scaleFactor < minScale) scaleFactor = minScale;
		if (scaleFactor > maxScale) scaleFactor = maxScale;

		gl.uniform4f(quadProgram.uRatio, ratioX * scaleFactor, ratioY * scaleFactor, 1, 1);
		gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
		gl.disable(gl.BLEND);
	}


	function resizeCanvas() {
		if (canvas.width != canvas.clientWidth || canvas.height != canvas.clientHeight) {
			canvas.width = canvas.clientWidth;
			canvas.height = canvas.clientHeight;
		}

		if (gl) {
			gl.viewport(0, 0, canvas.width, canvas.height);
		}

		if (canvas.width < canvas.height) {
			ratioX = 1;
			ratioY = canvas.width / canvas.height;
		}
		else {
			ratioX = canvas.height / canvas.width;
			ratioY = 1;
		}
	}

	function wheeldelta(event) {
		event = event || window.event;
		if (event.wheelDelta) return event.wheelDelta / 120.0;
		if (event.detail) return -event.detail / 3.0;
		if (event.originalEvent && event.originalEvent.wheelDelta)
			return e.originalEvent.wheelDelta / 120.0;
		return 0.0;
	}

	function mousewheel(event) {
		scaleFactor += wheeldelta(event) / 10.0;
		if (event.preventDefault)
			event.preventDefault();
		event.returnValue = false;
		return false;
	}

	function webGLStart() {
		canvas = document.getElementById("planet-canvas");
		resizeCanvas();

		gl = WebGLUtils.setupWebGL(canvas);
		if (gl) {
			gl.viewport(0, 0, canvas.width, canvas.height);
			gl.clearColor(0.0, 0.0, 0.0, 1.0);
			wgl = new WGL(gl);

			initShaders()
			initBuffers();
			//initTextures();

			//drawScene();
			tick();
		}
		else {
			alert("Could not initialize WebGL, sorry :-(");
		}

		canvas.addEventListener('mousewheel', mousewheel, false);
		canvas.addEventListener('DOMMouseScroll', mousewheel, false);
	}

	var mouseX = 0;
	var mouseY = 0;
	var lastDX = 0;
	var lastDY = 0;
	var lastMouseTime = 0;
	var mouseTime = 1;
	var mouseDown = false;

	document.onmousedown = function(event) {
		event = event || window.event;
		mouseX = event.offsetX ? (event.offsetX) : event.pageX - canvas.offsetLeft;
		mouseY = event.offsetY ? (event.offsetY) : event.pageY - canvas.offsetTop;
		mouseDown = true;
	}
	document.onmouseup = function(event) {
		event = event || window.event;
		mouseX = event.offsetX ? (event.offsetX) : event.pageX - canvas.offsetLeft;
		mouseY = event.offsetY ? (event.offsetY) : event.pageY - canvas.offsetTop;
		mouseDown = false;
	}
	document.onmousemove = function(event) {
		if (!mouseDown) return;
		event = event || window.event;
		var x = event.offsetX ? (event.offsetX) : event.pageX - canvas.offsetLeft;
		var y = event.offsetY ? (event.offsetY) : event.pageY - canvas.offsetTop;
		
		var dx = x - mouseX;
		var dy = y - mouseY;
		
		var scl = cScale;
		if (event.shiftKey) scl /= 10;
		if (event.ctrlKey) scl *= 2;
		
		cx += (dx / canvas.width) / ratioX * scl;
		cy -= (dy / canvas.height) / ratioY * scl;
		
		mouseX = x;
		mouseY = y;

	}
	
	var dcx = 0;
	var dcy = 0;
	var dspd = 0.005;
	var maxdc = 0.02;
	
	var lastTime = 0;

	function animate() {
		var timeNow = new Date().getTime();
		if (lastTime != 0 && !mouseDown) {
			var delta = (timeNow - lastTime)/1000;

			dcx += Math.random()*dspd - dspd/2;
			if (dcx < -maxdc) dcx = -maxdc;
			if (dcx > maxdc) dcx = maxdc;
			dcy += Math.random()*dspd - dspd/2;
			if (dcy < -maxdc) dcy = -maxdc;
			if (dcy > maxdc) dcy = maxdc;

			if (cx + midX > 0.5) dcx = -2*Math.abs(dcx);
			if (cx + midX < -2) dcx = 2*Math.abs(dcx);
			
			if (cy + midY > 1) dcy = -Math.abs(dcy);
			if (cy + midY < -1) dcy = Math.abs(dcy);

			midX += dcx * delta;
			midY += dcy * delta;
			
		}
		lastTime = timeNow;
	}

	function tick() {
		requestAnimFrame(tick);
		drawScene();
		animate();
	}

	// setInterval(function() {
	// 	drawScene();
	// }, 50);


	// document.onmousedown = function(event) {
	// 	event = event || window.event;
	// 	mouseX = event.offsetX ? (event.offsetX) : event.pageX - canvas.offsetLeft;
	// 	mouseY = event.offsetY ? (event.offsetY) : event.pageY - canvas.offsetTop;
	// 	lastDX = 0;
	// 	lastDY = 0;
	// 	mouseTime = 1;
	// 	rotateSpeed = 0;
	// 	tiltSpeed = 0;

	// 	document.onmousemove = function(event) {
	// 		event = event || window.event;
	// 		var x = event.offsetX ? (event.offsetX) : event.pageX - canvas.offsetLeft;
	// 		var y = event.offsetY ? (event.offsetY) : event.pageY - canvas.offsetTop;
	// 		var dx = x - mouseX;
	// 		var dy = y - mouseY;

	// 		rotateAngle -= dx / (canvas.width * ratioX * scaleFactor * Math.PI);
	// 		tiltAngle += dy * 0.5 / (canvas.height * ratioY * scaleFactor);

	// 		var timeNow = new Date().getTime();
	// 		if (lastMouseTime != 0) {
	// 			mouseTime = (timeNow - lastMouseTime) / 1000.0;
	// 		}
	// 		lastMouseTime = timeNow;

	// 		mouseX = x;
	// 		mouseY = y;
	// 		lastDX = dx;
	// 		lastDY = dy;
	// 	}
	// }

	// document.onmouseup = function(event) {
	// 	document.onmousemove = null;

	// 	var timeNow = new Date().getTime();
	// 	if (timeNow - lastMouseTime < 20) {
	// 		rotateSpeed = -lastDX / (canvas.width * ratioX * scaleFactor * Math.PI * mouseTime);
	// 		tiltSpeed = lastDY * 0.5 / (canvas.height * ratioY * scaleFactor * mouseTime);
	// 	}
	// }

	window.addEventListener('resize', resizeCanvas);
</script>

</head>

<style>
	canvas {
		-webkit-touch-callout: none;
		-webkit-user-select: none;
		-khtml-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		outline: none;
		-webkit-tap-highlight-color: rgba(255, 255, 255, 0);
	}
	#divInfo {
		font-family: courier;
		color: green;
		position: absolute;
		left: 0px;
		top: 0px;
	}
</style>

<body onload="webGLStart();">
	<canvas id="planet-canvas" style="position:absolute; top:0px; left:0px; background-color:#000000; width:100%; height:100%;"></canvas>
	<div id="divInfo">INFO</div>
</body>

</html>

