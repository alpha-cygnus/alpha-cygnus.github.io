<html>
<head>
<meta charset="utf-8"> 
<title>MHU-1</title>
<script src="../lib/jquery-2.1.1.js"></script>
<script src="../lib/Tone.js"></script>
<script src="../lib/oo.js"></script>
<script src="../lib/aa.js"></script>
<script src="../lib/handlebars-v2.0.0.js"></script>
<script>
var theRack = AA.newObj(['Rack',
	['Osc', {t: 'sawtooth'}],
	['Osc', {t: 'sawtooth'}],
	['Osc', {t: 'square'}],
	['Amp'],
	['Amp'],
	['Filter', {q: 15}],
	['Filter', {q: 15}],
	//['Filter', {q: 10}],
	['Env', {a:0.3, d:0.5, s:0.4, r:0.8}],
	['Env', {a:0, d:0.5, s:0.8, r:0.2}],
	['Env', {min:-1, max:1, a:0.2, d:0.2, s:0.5, r:1}],
	['Env', {a:5, d:0, s:1, r:1}],
	['Mono'],
	['Const'],
	['Keyboard', {p: 0.05}],
	{
		'O1>F1': 0.2,
		'O2>F1': 0.2,
		//'O3>F1': 0.2,
		'O1>A1': 0.2,
		'O2>A1': 0.2,
		'O3>A2': 0.2,
		'F1>F2': 1,
		'F2>A1': 0.5,
		'A1>M1': 0.5,
		'A2>M1': 0.5,
		'E1>A1.g':1,
		//'E2>A2.g':1,
		'E4>A2.g':1,
		'E3>F1.n':36,
		'E3>F2.n':36,
		'K1>O1.n':1,
		'K1>O2.n':1,
		'K1>O3.n':1,
		'K1>F1.n':1,
		'K1>F2.n':1,
		'C1>O1.n':-0.1,
		'C1>O2.n':+0.1,
		'C1>O3.n':-24,
		'C1>F1.n':+24,
		'C1>F2.n':+24,
		'g:K1>E1':1,
		'g:K1>E2':1,
		'g:K1>E3':1,
		'g:K1>E4':1,
	}
]);
var keysDown = {};
var keysToNotes = {
	81: 60,
	50: 61,
	87: 62,
	51: 63,
	69: 64,
	82: 65,
	53: 66,
	84: 67,
	54: 68,
	89: 69,
	55: 71,
	85: 72,
	73: 73,
	57: 74,
	79: 75,
	48: 76,
	80: 77,
	
	90: 48,
	83: 49,
	88: 50,
	68: 51,
	67: 52,
	86: 53,
	71: 54,
	66: 55,
	72: 56,
	78: 57,
	74: 58,
	77: 59,
	188: 60,
	76: 61,
	190: 62,
	186: 63,
	191: 64,
};
$(window).on('keydown', function(e) {
	//console.log('keydown', e);
	if (keysDown[e.keyCode]) return;
	console.log('down', e.keyCode);
	keysDown[e.keyCode] = 1;
	var n = keysToNotes[e.keyCode];
	if (n) {
		for (k in AA.keyboards) {
			AA.keyboards[k].trig(e.shiftKey ? undefined : 1, n);
		}
	}
});
$(window).on('keyup', function(e) {
	//console.log('up', e.keyCode);
	keysDown[e.keyCode] = 0;
	var n = keysToNotes[e.keyCode];
	if (n) {
		for (k in AA.keyboards) {
			AA.keyboards[k].trig(e.shiftKey ? undefined : 0, n);
		}
	}
});

var hbTemplates = {};
$(function() {
	$('.hbPartial').map(function() {
		Handlebars.registerPartial(this.id, $(this).html());
	});

	$('script[type="text/x-hb-template"]').map(function() {
		hbTemplates[this.id] = Handlebars.compile($(this).html());
	});
	
	Handlebars.registerHelper('call', function(name) {
		return new Handlebars.SafeString(hbTemplates[name](this));
	});

	Handlebars.registerHelper('clog', function(what) {
		console.log(what);
		return '';
	});
	Handlebars.registerHelper('callEach', function(list, name) {
		res = [];
		for (var i in list) {
			console.log(list[i]);
			res.push(hbTemplates[name](list[i]));
		}
		console.log(res);
		return new Handlebars.SafeString(res.join(''));
	});
	Handlebars.registerHelper('connTpl', function(mtx, d0, o0, d1, i1) {
		console.log(mtx, d0, o0, d1, i1);
		
		return new Handlebars.SafeString(hbTemplates['conn' + mtx.kind](mtx.getConnector(d0 + '.' + o0, d1 + '.' + i1)));
	});
	Handlebars.registerHelper('round', function(v, n) {
		return new Handlebars.SafeString((Math.round(v*100)/100).toString().replace('-', '&ndash;'));
	});

	$('#devices').html(hbTemplates.aaRack(theRack));
});


</script>
<script type="text/x-hb-template" id="aaRack">
	{{#each devList}}
		{{call 'aaDevice'}}
	{{/each}}
	{{#matrixAnalog}}
		{{call 'aaMatrix'}}
	{{/matrixAnalog}}
	{{#matrixGate}}
		{{call 'aaMatrix'}}
	{{/matrixGate}}
</script>
<script type="text/x-hb-template" id="aaDevice">
	<div>
	{{name}}: {{_cls}}
	{{#each listParam}}
		{{call 'aaParam'}}
	{{/each}}
	</div>
</script>
<script type="text/x-hb-template" id="aaParam">
	{{name}}={{_value}}
</script>
<script type="text/x-hb-template" id="aaMatrix">
	<h2>{{kind}} {{_cls}}</h2>
	<table class="aaMatrix">
		<tr>
			<th></th>
			{{#each inList}}<th>{{device.name}}<sub>{{name}}</sub></th>{{/each}}
		</tr>
		{{#each outList}}
		<tr>
			<th>{{device.name}}<sub>{{name}}</sub></th>
			{{#each ../inList}}<td align="center">{{ connTpl ../.. ../device.name ../name device.name name }}</td>{{/each}}
		</tr>
		{{/each}}
	</table>
</script>
<script type="text/x-hb-template" id="inTH">
	<th>{{name}}:{{_cls}}</th>
</script>
<script type="text/x-hb-template" id="connAnalog">
	{{#if _value}}{{round _value}}{{/if}}
</script>
<script type="text/x-hb-template" id="connGate">
	{{#if _value}}*{{/if}}
</script>
</head>
<style>
	.hbTemplate, .hbPartial {
		display: none;
	}
	.aaMatrix tr:nth-child(2n+1) {
		background: #DDD;
	}
</style>
<body>
	<div id="devices">
	</div>
</body>
</html>	